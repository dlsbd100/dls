<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quarterfinal Fixers</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-semibold mb-4">Quarterfinal Fixers</h1>
        
        <!-- Quarterfinal Matches -->
        <div id="quarterfinalsContainer">
            <!-- Matches will be injected here -->
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
        authDomain: "dlstournament-31ac1.firebaseapp.com",
        projectId: "dlstournament-31ac1",
        storageBucket: "dlstournament-31ac1.appspot.com",
        messagingSenderId: "874377019055",
        appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function loadPointTables() {
        const snapshot = await getDocs(collection(db, "pointTables"));
        const quarterfinalsContainer = document.getElementById("quarterfinalsContainer");

        if (snapshot.empty) {
          quarterfinalsContainer.innerHTML = `<p class="text-gray-500 text-center">No point tables to show.</p>`;
          return;
        }

        const pointTables = [];
        snapshot.forEach(doc => pointTables.push(doc.data()));

        // For each group, sort teams and pick top 2
        const quarterfinalTeams = [];

        pointTables.forEach(pointTable => {
          pointTable.teams.sort((a, b) => {
            if (b.points === a.points) {
              return b.goals - a.goals; // If points are equal, sort by goals
            }
            return b.points - a.points; // Otherwise, sort by points
          });

          // Get top 2 teams from each group
          const topTwo = pointTable.teams.slice(0, 2);
          quarterfinalTeams.push(...topTwo);
        });

        // Now generate the quarterfinal matches
        let html = "<div class='mb-4'>";
        for (let i = 0; i < quarterfinalTeams.length; i += 2) {
          const team1 = quarterfinalTeams[i];
          const team2 = quarterfinalTeams[i + 1];

          html += `
            <div class="border p-4 rounded shadow-sm mb-4 bg-white">
              <div class="flex justify-between items-center text-lg font-semibold">
                <div>${team1.team}</div>
                <div>VS</div>
                <div>${team2.team}</div>
              </div>
              <div class="text-sm text-center text-gray-500 mt-2">Quarterfinal Match</div>
              <button id="startMatch${i}" class="bg-blue-500 text-white rounded py-2 px-4 mt-4">Start Match</button>
            </div>
          `;
        }

        html += "</div>";
        quarterfinalsContainer.innerHTML = html;
        
        // Attach event listeners to start match buttons
        for (let i = 0; i < quarterfinalTeams.length; i += 2) {
          document.getElementById(`startMatch${i}`).addEventListener('click', () => {
            startQuarterfinalMatch(i);
          });
        }
      }

      async function startQuarterfinalMatch(matchIndex) {
        const team1 = document.querySelectorAll('#quarterfinalsContainer .border')[matchIndex].querySelectorAll('.flex > div')[0].textContent;
        const team2 = document.querySelectorAll('#quarterfinalsContainer .border')[matchIndex].querySelectorAll('.flex > div')[2].textContent;

        // Create a new fixer for this match
        await addDoc(collection(db, "fixers"), {
          team1,
          team2,
          date: new Date().toISOString().split("T")[0], // Set to current date for now
          team1Goal: null,
          team2Goal: null,
          status: "Pending"
        });

        // You can also create a match preview or proceed to actual match screen.
        alert(`Quarterfinal match between ${team1} and ${team2} has been scheduled!`);
      }

      // Load the point tables to generate the quarterfinal matches
      loadPointTables();
    </script>
</body>
</html>
