<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Players List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-md relative">
    <div class="max-w-7xl mx-auto px-4 py-3 relative flex items-center justify-center">
      <p onclick="window.location.href='admin.html'" class="absolute left-4 text-gray-700 cursor-pointer">
        <i class="fas fa-arrow-left text-2xl"></i>
      </p>
      <h1 class="text-xl font-bold text-gray-800">Players List</h1>
    </div>
  </header>

  <!-- Main -->
  <main class="p-4 md:p-6 space-y-6 overflow-auto flex-grow">

    <!-- Players List Section -->
    <div class="bg-white shadow rounded p-4">
      <div class="text-xl font-semibold text-blue-700 mb-4">Players List</div>
      <div class="overflow-x-auto max-h-[600px]">
        <table class="w-full text-xs border border-gray-300 rounded overflow-hidden min-w-[600px]">
          <thead class="bg-gray-100 sticky top-0 z-10">
            <tr>
              <th class="p-2 border w-32">Team</th>
            </tr>
          </thead>
          <tbody id="playersTableBody">
            <tr><td colspan="1" class="p-3 text-center text-gray-500">Loading players...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quarterfinal Fixers -->
    <div class="bg-white shadow rounded p-4">
      <div class="text-xl font-semibold text-blue-700 mb-4">Quarterfinal Fixers</div>
      <button id="createQuarterfinalsBtn" class="bg-green-600 text-white text-sm px-3 py-2 rounded hover:bg-green-700">
        Create Quarterfinal Fixers
      </button>
      <div id="quarterfinalsContainer" class="mt-4">
        <!-- Quarterfinal matches will be displayed here -->
      </div>
    </div>

  </main>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a",
      measurementId: "G-0DGFJEV6GL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadPlayers();
        loadPointTables();
      }
    });

    async function loadPlayers() {
      try {
        const playersSnapshot = await getDocs(collection(db, "playersform"));
        const playersTableBody = document.getElementById("playersTableBody");

        if (playersSnapshot.empty) {
          playersTableBody.innerHTML = `<tr><td colspan="1" class="text-center p-3">No players found.</td></tr>`;
          return;
        }

        let html = "";
        playersSnapshot.forEach(doc => {
          const p = doc.data();
          html += `
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2 border">${p.team || "N/A"}</td>
            </tr>`;
        });

        playersTableBody.innerHTML = html;

      } catch (e) {
        console.error("Error loading players:", e);
        document.getElementById("playersTableBody").innerHTML = `<tr><td colspan="1" class="text-center text-red-600">${e.message}</td></tr>`;
      }
    }

    async function loadPointTables() {
      const snapshot = await getDocs(collection(db, "pointTables"));
      const pointTables = [];
      snapshot.forEach(doc => pointTables.push(doc.data()));

      // Sorting and displaying the point tables
      let allPointTablesHTML = "";
      pointTables.forEach((pointTable, index) => {
        pointTable.teams.sort((a, b) => b.points - a.points); // Sort by points

        allPointTablesHTML += `
          <div class="mb-4">
            <div class="font-semibold mb-1 text-blue-700">Point Table - Group ${String.fromCharCode(65 + index)}</div>
            <table class="text-sm w-full table-auto border border-gray-200">
              <thead class="bg-gray-200">
                <tr>
                  <th class="px-2 py-1 border">#</th>
                  <th class="px-2 py-1 border">Team</th>
                  <th class="px-2 py-1 border text-center">Points</th>
                </tr>
              </thead>
              <tbody>
                ${pointTable.teams.map((team, i) => `
                  <tr>
                    <td class="px-2 py-1 border text-center">${i + 1}</td>
                    <td class="px-2 py-1 border">${team.team}</td>
                    <td class="px-2 py-1 border text-center">${team.points}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      });

      document.getElementById("quarterfinalsContainer").innerHTML = allPointTablesHTML;
    }

    document.getElementById("createQuarterfinalsBtn").addEventListener("click", async () => {
      const snapshot = await getDocs(collection(db, "pointTables"));
      const quarterfinalsMatches = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const top2Teams = data.teams.slice(0, 2); // Top 2 teams from each group

        // Creating the quarterfinals based on the top 2 teams
        for (let i = 0; i < top2Teams.length; i++) {
          for (let j = i + 1; j < top2Teams.length; j++) {
            const match = {
              team1: top2Teams[i].team,
              team2: top2Teams[j].team,
              date: new Date().toISOString().split("T")[0], // Placeholder date, can be customized
              status: "Pending",
              team1Goal: null,
              team2Goal: null
            };
            quarterfinalsMatches.push(match);
          }
        }
      });

      // Save quarterfinals matches in the Firestore "fixers" collection
      for (const match of quarterfinalsMatches) {
        await addDoc(collection(db, "fixers"), match);
      }

      Swal.fire({
        icon: 'success',
        title: `Quarterfinal matches created.`,
        position: 'top-end',
        toast: true,
        timer: 3000,
        showConfirmButton: false
      });

      loadQuarterfinalMatches();
    });

    async function loadQuarterfinalMatches() {
      const fixersSnapshot = await getDocs(collection(db, "fixers"));
      const fixersContainer = document.getElementById("quarterfinalsContainer");
      let matchCardsHTML = "";

      fixersSnapshot.forEach(doc => {
        const match = doc.data();
        matchCardsHTML += `
          <div class="border p-2 rounded shadow-sm text-xs space-y-1 bg-white mb-1">
            <div class="text-center text-[13px] text-gray-500 font-semibold">${match.date}</div>
            <div class="flex justify-between items-center px-2">
              <div class="text-sm font-semibold text-gray-600">${match.team1} <span class="text-black">(${match.team1Goal ?? "-"})</span></div>
              <div class="text-base font-bold text-red-500">VS</div>
              <div class="text-sm font-semibold text-gray-600">${match.team2} <span class="text-black">(${match.team2Goal ?? "-"})</span></div>
            </div>
            <div class="text-center text-green-600 text-xs font-medium">Winner: ${match.team1Goal && match.team2Goal ? (match.team1Goal > match.team2Goal ? match.team1 : match.team2) : "Pending"}</div>
            <div class="text-center text-blue-600 text-xs font-medium">Status: ${match.status}</div>
          </div>
        `;
      });

      fixersContainer.innerHTML = matchCardsHTML;
    }

    // Load existing quarterfinal matches on page load
    loadQuarterfinalMatches();

  </script>

</body>
</html>
